{% extends 'base.html' %}

{% block title %}Live Fruit Detection{% endblock %}

{% block content %}
    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-3 shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title">Live Camera Feed</h5>

                    <div class="d-flex justify-content-center mb-2">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="streamMode" id="modeBrowser" value="browser" checked>
                            <label class="form-check-label" for="modeBrowser">Browser Camera</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="streamMode" id="modeServer" value="server">
                            <label class="form-check-label" for="modeServer">Server Stream</label>
                        </div>
                    </div>

                    <div class="ratio ratio-16x9 bg-dark rounded" style="max-height:540px;">
                        <video id="videoStream" autoplay muted playsinline style="width:100%;height:100%;object-fit:cover;"></video>
                        <img id="mjpegStream" alt="server stream" style="width:100%;height:100%;object-fit:cover;display:none;" />
                    </div>

                    <div class="mt-3">
                        <button id="captureBtn" class="btn btn-primary me-2">Capture & Detect</button>
                        <button id="toggleStream" class="btn btn-outline-secondary">Stop Camera</button>
                        <button id="refreshServer" class="btn btn-outline-secondary d-none">Refresh Server Frame</button>
                    </div>

                    <div id="cameraNotice" class="small text-muted mt-2">Allow camera permission when prompted. Server stream requires the Python process to have camera access.</div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-3 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Detections</h5>
                    <ul id="detectionsList" class="list-group list-group-flush small">
                        <li class="list-group-item">No detections yet</li>
                    </ul>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">Tips</h6>
                    <ul class="small mb-0">
                        <li>Use good lighting for better detection.</li>
                        <li>Place single fruit items near the center.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
// Elements
let streamRef = null;
const video = document.getElementById('videoStream');
const mjpeg = document.getElementById('mjpegStream');
const captureBtn = document.getElementById('captureBtn');
const toggleBtn = document.getElementById('toggleStream');
const refreshBtn = document.getElementById('refreshServer');
const detectionsList = document.getElementById('detectionsList');

async function startCamera(){
    try{
        streamRef = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }, audio: false });
        video.srcObject = streamRef;
        await video.play();
        toggleBtn.textContent = 'Stop Camera';
        document.getElementById('cameraNotice').textContent = 'Browser camera active.';
    } catch(err){
        console.error('Camera start error', err);
        document.getElementById('cameraNotice').textContent = 'Camera access denied or not available. Check browser permissions and try again.';
    }
}

function stopCamera(){
    if(streamRef){
        streamRef.getTracks().forEach(t=>t.stop());
        streamRef = null;
        video.srcObject = null;
        toggleBtn.textContent = 'Start Camera';
        document.getElementById('cameraNotice').textContent = 'Browser camera stopped.';
    }
}

function enableServerStream(){
    // stop client camera if running
    stopCamera();
    mjpeg.style.display = 'block';
    video.style.display = 'none';
    refreshBtn.classList.remove('d-none');
    toggleBtn.classList.add('d-none');
    mjpeg.src = '{{ url_for('video_feed') }}?t=' + Date.now();
    document.getElementById('cameraNotice').textContent = 'Displaying server-side stream.';
}

function disableServerStream(){
    mjpeg.src = '';
    mjpeg.style.display = 'none';
    video.style.display = 'block';
    refreshBtn.classList.add('d-none');
    toggleBtn.classList.remove('d-none');
    document.getElementById('cameraNotice').textContent = 'Browser camera mode.';
}

document.getElementsByName('streamMode').forEach(r=> r.addEventListener('change', (e)=>{
    if(e.target.value === 'server') enableServerStream(); else disableServerStream();
}));

refreshBtn.addEventListener('click', ()=>{ mjpeg.src = '{{ url_for('video_feed') }}?t=' + Date.now(); });

toggleBtn.addEventListener('click', ()=>{ if(streamRef) stopCamera(); else startCamera(); });

captureBtn.addEventListener('click', async function(){
    // capture from visible source (video or mjpeg)
    if(mjpeg.style.display === 'block'){
        // For server MJPEG, capture by requesting a single frame from server via /capture endpoint isn't implemented.
        // Fallback: fetch a fresh frame by loading the image, then draw to canvas.
        try{
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.src = '{{ url_for('video_feed') }}?t=' + Date.now();
            await new Promise((res, rej)=>{ img.onload = res; img.onerror = rej; });
            const c = document.createElement('canvas'); c.width = img.naturalWidth || 640; c.height = img.naturalHeight || 480; const ctx = c.getContext('2d'); ctx.drawImage(img,0,0,c.width,c.height);
            const dataUrl = c.toDataURL('image/jpeg', 0.8);
            await sendForDetection(dataUrl);
        } catch(err){ console.error('Server-frame capture failed', err); alert('Failed to capture server frame'); }
    } else {
        if(!video || !video.videoWidth){ alert('Camera not ready'); return; }
        const c = document.createElement('canvas'); c.width = video.videoWidth; c.height = video.videoHeight; const ctx = c.getContext('2d'); ctx.drawImage(video, 0, 0, c.width, c.height); const dataUrl = c.toDataURL('image/jpeg', 0.8); await sendForDetection(dataUrl);
    }
});

async function sendForDetection(dataUrl){
    try{
        const res = await fetch('{{ url_for('detect_objects') }}', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ image_data: dataUrl }) });
        const json = await res.json();
        renderDetections(json);
    } catch(err){ console.error('Detection request failed', err); alert('Detection request failed â€” check server logs'); }
}

function renderDetections(json){
    detectionsList.innerHTML = '';
    if(!json || json.length === 0){ detectionsList.innerHTML = '<li class="list-group-item">No objects detected</li>'; return; }
    for(const d of json){ const li = document.createElement('li'); li.className = 'list-group-item d-flex justify-content-between align-items-start'; li.innerHTML = `<div><strong>${d.class}</strong><div class="small text-muted">confidence: ${(d.confidence||0).toFixed(2)}</div></div><div class="text-nowrap">${d.bbox?('bbox: ['+d.bbox.map(v=>v.toFixed?Number(v).toFixed(0):v).join(', ')+']'):'-'}</div>`; detectionsList.appendChild(li); }
}

// Auto-start browser camera by default
startCamera();
</script>
{% endblock %}
